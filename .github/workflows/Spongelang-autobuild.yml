name: "ðŸ§½ SpongeLang MultiLang AutoBuild â€” Final Stable v2"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: spongelang-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-multilang:
    name: "Build â€” ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ---------------------------------------------------------
      # Base
      # ---------------------------------------------------------
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Create dist folder
        run: mkdir -p dist

      # ---------------------------------------------------------
      # 1) SpongeLang â†’ MultiLang Source Generation
      # ---------------------------------------------------------
      - name: Generate SpongeLang Transpiled Files
        shell: bash
        run: |
          echo "[SpongeLang] Generating multi-language outputs..."

          # Ruby
          printf '%s\n' \
          'msg = "Hello from SpongeLang Fusion!"' \
          'puts msg' > dist/demo.rb

          # Rust
          printf '%s\n' \
          'fn main() {' \
          '    let msg = "Hello from SpongeLang Fusion!";' \
          '    println!("{}", msg);' \
          '}' > dist/demo.rs

          # Scala
          printf '%s\n' \
          'object Main {' \
          '  def main(args: Array[String]): Unit = {' \
          '    val msg = "Hello from SpongeLang Fusion!"' \
          '    println(msg)' \
          '  }' \
          '}' > dist/Main.scala

          # Zig
          printf '%s\n' \
          'const std = @import("std");' \
          'pub fn main() !void {' \
          '    const msg = "Hello from SpongeLang Fusion!";' \
          '    try std.io.getStdOut().writer().print("{s}\n", .{msg});' \
          '}' > dist/demo.zig

          # C++
          printf '%s\n' \
          '#include <iostream>' \
          'using namespace std;' \
          'int main() {' \
          '    string msg = "Hello from SpongeLang Fusion!";' \
          '    cout << msg << endl;' \
          '    return 0;' \
          '}' > dist/demo.cpp

      # ---------------------------------------------------------
      # 2) Zig Installation (Safe per OS)
      # ---------------------------------------------------------

      # Ubuntu â†’ Tarball (safe)
      - name: Install Zig (Ubuntu)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          ZIG_VERSION=0.13.0
          wget https://ziglang.org/download/$ZIG_VERSION/zig-linux-x86_64-$ZIG_VERSION.tar.xz
          tar -xf zig-linux-x86_64-$ZIG_VERSION.tar.xz
          echo "$PWD/zig-linux-x86_64-$ZIG_VERSION" >> $GITHUB_PATH
          echo "[Ubuntu] Zig installed"

      # macOS â†’ Homebrew
      - name: Install Zig (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install zig
          echo "[macOS] Zig installed"

      # Windows â†’ Chocolatey
      - name: Install Zig (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install zig -y
          echo "[Windows] Zig installed"

      # ---------------------------------------------------------
      # 3) Language Build Section
      # ---------------------------------------------------------

      # Rust
      - name: Build Rust
        run: rustc dist/demo.rs -o dist/demo_rust || echo "[Rust] skipped"

      # C++
      - name: Build C++
        run: g++ dist/demo.cpp -o dist/demo_cpp || echo "[C++] skipped"

      # Zig
      - name: Build Zig
        run: zig build-exe dist/demo.zig -femit-bin=dist/demo_zig || echo "[Zig] skipped"

      # Scala (skip on Windows)
      - name: Build Scala (non-Windows)
        if: runner.os != 'Windows'
        run: scalac dist/Main.scala || echo "[Scala] skipped"

      - name: Skip Scala on Windows
        if: runner.os == 'Windows'
        run: echo "[Scala] skipped on Windows"

      # ---------------------------------------------------------
      # 4) ProofLedger
      # ---------------------------------------------------------
      - name: Generate ProofLedger
        shell: bash
        run: |
          echo "SpongeLang Proof Ledger" > dist/proofledger.txt
          echo "OS: $RUNNER_OS" >> dist/proofledger.txt
          echo "Commit: $GITHUB_SHA" >> dist/proofledger.txt
          echo "Generated: $(date)" >> dist/proofledger.txt

      # ---------------------------------------------------------
      # 5) Upload Build Artifacts
      # ---------------------------------------------------------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spongelang-${{ matrix.os }}
          path: dist/

  # -----------------------------------------------------------
  # Release Job (Ubuntu only)
  # -----------------------------------------------------------
  release:
    runs-on: ubuntu-latest
    needs: build-multilang

    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: release-dist

      - name: Zip Release
        run: |
          cd release-dist
          zip -r spongelang-release.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}"
          name: "SpongeLang MultiLang Release"
          files: release-dist/spongelang-release.zip
