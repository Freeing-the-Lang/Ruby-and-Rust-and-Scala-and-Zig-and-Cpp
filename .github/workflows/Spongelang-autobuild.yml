name: "üßΩ SpongeLang MultiLang AutoBuild"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: spongelang-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-multilang:
    name: "Build ‚Äî ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Create dist folder
        run: mkdir -p dist

      # ---------------------------------------------------------
      # 1) SpongeLang ‚Üí 5Í∞ú Ïñ∏Ïñ¥ ÌååÏùº ÏÉùÏÑ± (Ruby/Rust/Scala/Zig/Cpp)
      # ---------------------------------------------------------
      - name: Generate SpongeLang Transpiled Files
        shell: bash
        run: |
          echo "Generating SpongeLang multi-language output..."

          printf '%s\n' 'msg = "Hello from SpongeLang Fusion!"' 'puts msg' > dist/demo.rb

          printf '%s\n' \
          'fn main() {' \
          '    let msg = "Hello from SpongeLang Fusion!";' \
          '    println!("{}", msg);' \
          '}' > dist/demo.rs

          printf '%s\n' \
          'object Main {' \
          '  def main(args: Array[String]): Unit = {' \
          '    val msg = "Hello from SpongeLang Fusion!"' \
          '    println(msg)' \
          '  }' \
          '}' > dist/Main.scala

          printf '%s\n' \
          'const std = @import("std");' \
          'pub fn main() !void {' \
          '    const msg = "Hello from SpongeLang Fusion!";' \
          '    try std.io.getStdOut().writer().print("{s}\n", .{msg});' \
          '}' > dist/demo.zig

          printf '%s\n' \
          '#include <iostream>' \
          'using namespace std;' \
          'int main() {' \
          '    string msg = "Hello from SpongeLang Fusion!";' \
          '    cout << msg << endl;' \
          '    return 0;' \
          '}' > dist/demo.cpp

      # ---------------------------------------------------------
      # 2) Ïñ∏Ïñ¥Î≥Ñ ÎπåÎìú (ÏóÜÏúºÎ©¥ ÏóêÎü¨ Î¨¥Ïãú)
      # ---------------------------------------------------------
      - name: Install deps (Ubuntu only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc g++ zig scala

      - name: Build Rust
        run: rustc dist/demo.rs -o dist/demo_rust || echo "Rust build skipped"

      - name: Build C++
        run: g++ dist/demo.cpp -o dist/demo_cpp || echo "C++ build skipped"

      - name: Build Zig
        run: zig build-exe dist/demo.zig -femit-bin=dist/demo_zig || echo "Zig build skipped"

      - name: Build Scala
        run: scalac dist/Main.scala || echo "Scala build skipped"

      # ---------------------------------------------------------
      # 3) ProofLedger
      # ---------------------------------------------------------
      - name: Generate ProofLedger
        shell: bash
        run: |
          echo "SpongeLang Proof Ledger" > dist/proofledger.txt
          echo "OS: $RUNNER_OS" >> dist/proofledger.txt
          echo "Commit: $GITHUB_SHA" >> dist/proofledger.txt
          echo "Generated: $(date)" >> dist/proofledger.txt

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spongelang-${{ matrix.os }}
          path: dist/


  # -------------------------------------------------------------
  # Release job ‚Äî Ubuntu Í≤∞Í≥ºÎßå ÏÇ¨Ïö©, ZIP ÏÉùÏÑ±
  # -------------------------------------------------------------
  release:
    runs-on: ubuntu-latest
    needs: build-multilang

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: release-dist

      - name: Zip release
        run: |
          cd release-dist
          zip -r spongelang-release.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}"
          name: "SpongeLang MultiLang Release"
          files: release-dist/spongelang-release.zip
